<div class="chat">
  <div class="chat__wrapper">
    <!-- Chat Header -->
    <div class="chat__header">
      <h1 class="chat__title">Research Chat</h1>
      <button 
        class="chat__header-btn" 
        (click)="toggleContextSidebar()"
        [attr.aria-label]="showContextSidebar ? 'Hide context sidebar' : 'Show context sidebar'"
      >
        <span class="material-symbols-outlined">library_books</span>
      </button>
    </div>

    <div class="chat__content">
      <!-- Messages Area -->
      <div class="chat__messages">
        <div class="chat__messages-list">
          <div 
            *ngFor="let message of messages" 
            class="message"
            [ngClass]="{
              'message--user': message.type === 'user',
              'message--assistant': message.type === 'assistant',
              'message--thinking': message.type === 'thinking'
            }"
          >
            <!-- User Message -->
            <ng-container *ngIf="message.type === 'user'">
              <div class="message__content message__content--user">
                <div class="message__text-wrapper">
                  <p class="message__sender">You</p>
                  <div class="message__bubble message__bubble--user">
                    <p class="message__text">{{ message.content }}</p>
                  </div>
                </div>
                <div 
                  class="message__avatar"
                  [style.background-image]="'url(' + userAvatar + ')'"
                ></div>
              </div>
            </ng-container>

            <!-- Assistant Message -->
            <ng-container *ngIf="message.type === 'assistant'">
              <div class="message__content message__content--assistant">
                <div 
                  class="message__avatar"
                  [style.background-image]="'url(' + assistantAvatar + ')'"
                ></div>
                <div class="message__text-wrapper">
                  <p class="message__sender">AI Assistant</p>
                  <div class="message__bubble message__bubble--assistant">
                    <p class="message__text">{{ message.content }}</p>
                  </div>
                    <button 
                    *ngIf="message.sources && message.sources.length > 0" 
                    class="message__sources-btn"
                    (click)="toggleSources(message.id)"
                  >
                    <span class="material-symbols-outlined">library_books</span>
                    <span>{{ message.showSources ? 'Hide Sources' : 'View Sources' }} ({{ message.sources.length }})</span>
                  </button>
                  
                  <!-- Sources List -->
                  <div *ngIf="message.showSources" class="message__sources-list">
                    <div *ngFor="let source of message.sources" class="source-item">
                      <div class="source-item__header">
                        <span class="source-item__title">{{ source.paperTitle }}</span>
                        <span class="source-item__type">{{ source.section }}</span>
                      </div>
                      <div class="source-item__details">
                        <a *ngIf="source.pdf_url" [href]="source.pdf_url" target="_blank" class="source-link">View PDF</a>
                        <span class="source-item__id">ID: {{ source.doc_id.substring(0, 8) }}...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- Thinking State -->
            <ng-container *ngIf="message.type === 'thinking'">
              <div class="message__content message__content--assistant">
                <div 
                  class="message__avatar"
                  [style.background-image]="'url(' + assistantAvatar + ')'"
                ></div>
                <div class="message__thinking">
                  <span class="message__thinking-dot"></span>
                  <span class="message__thinking-dot"></span>
                  <span class="message__thinking-dot"></span>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Context Sidebar -->
      <div 
        class="chat__sidebar" 
        *ngIf="showContextSidebar"
      >
        <div class="chat__sidebar-header">
          <h2 class="chat__sidebar-title">
            Select Context
          </h2>
          <button 
            class="chat__sidebar-close"
            (click)="toggleContextSidebar()"
            aria-label="Close context sidebar"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="chat__sidebar-content">
          
          <!-- Context Selection Mode -->
          <div *ngIf="sidebarMode === 'context'" class="context-list">
            <p class="sidebar-hint">Select papers to use as context for your chat.</p>
            <div 
              *ngFor="let paper of contextPapers"
              class="context-item"
              [class.context-item--selected]="paper.isSelected"
              (click)="togglePaperSelection(paper)"
            >
              <div class="context-item__checkbox">
                <span class="material-symbols-outlined">
                  {{ paper.isSelected ? 'check_box' : 'check_box_outline_blank' }}
                </span>
              </div>
              <div class="context-item__info">
                <h3 class="context-item__title">{{ paper.title }}</h3>
                <p class="context-item__meta">{{ paper.authors }}</p>
              </div>
            </div>
          </div>

          <!-- Sources Mode -->
          <div *ngIf="sidebarMode === 'sources'" class="sources-list">
            <div 
              *ngFor="let source of currentSources"
              class="context-card"
            >
              <h3 class="context-card__title">{{ source.title }}</h3>
              <p class="context-card__authors">
                <span class="badge">{{ source.chunk_type }}</span>
                ID: {{ source.doc_id.substring(0, 8) }}...
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="chat__composer">
      <div class="chat__input-wrapper">
        <textarea
          class="chat__input"
          [(ngModel)]="userMessage"
          (keydown)="onKeyDown($event)"
          placeholder="Ask a question about your research papers..."
          rows="1"
        ></textarea>
        <div class="chat__input-actions">
          <button 
            class="chat__input-btn chat__input-btn--secondary chat__input-btn--text"
            (click)="openAddSources()"
            aria-label="Add sources"
          >
            <span class="material-symbols-outlined">add_circle</span>
            <span>Add Sources</span>
          </button>
          <button 
            class="chat__input-btn chat__input-btn--primary"
            (click)="sendMessage()"
            [disabled]="!userMessage.trim()"
            aria-label="Send message"
          >
            <span class="material-symbols-outlined">arrow_upward</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>